%:strip
% This optional plugin (see ptx-plugins) provides ptx2pdf users with 
% access to decorative ornaments distributed as part of latex package pgfornaments,
% It does not include those ornaments, which are available at https://www.ctan.org/pkg/pgfornament
%
% This code thus includes a  XeTeX-specific, partial reimplementation of some portions
% of the pgfornament package to use the pgf-vectorian (and other) ornaments,
% but without loading (any of) pgf. 
% It also adds auto-filling and scaling functionality not found in that original package.
%
% Copyright (c) 2021 by SIL International written by David Gardner
%
% Some portions of this code derive from the pgfornament.sty file  (v0.2)
%  (C) 2016 Alain Matthes,  which was released under LaTeX Project Public
%  License. 
% Other portions de-abstract the abstraction layers from the pdf drivers from
% the pgf package, released under the same licence.
% 
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  
% MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  
% NONINFRINGEMENT. IN NO EVENT SHALL SIL INTERNATIONAL BE LIABLE FOR  
% ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF  
% CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION  
% WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
%
% Except as contained in this notice, the name of SIL International  
% shall not be used in advertising or otherwise to promote the sale,  
% use or other dealings in this Software without prior written  
% authorization from SIL International.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\plugin@startif{cover}

% Input parameters - TO BE OVERRIDDEN! 
\x@\edef\csname cover-bleed\endcsname{10mm}   % Bleed dimension
\x@\edef\csname cover-spine\endcsname{11mm}   % Actual spine width = book thickness, endpapers, board thickness, etc.
\x@\edef\csname cover-y\endcsname{\the\PaperHeight} % spine/book height 
\x@\edef\csname cover-x\endcsname{\the\PaperWidth} % Front/back cover
\x@\edef\csname cover-back-spinewrap\endcsname{0mm} %  Should the graphic/colour on the spine be given extra space?
\x@\edef\csname cover-front-spinewrap\endcsname{0mm} % 
% NB: cover-spine is used to set fold-marks, and should be the actual value
% if cover-X-spinewrap is non-zero, that space is added to the spine and removed from the front/back cover.

\newif\ifrotatespine
\rotatespinetrue
\def\c@verbit#1#2{%
  %\tracingall
  \h@ldfigtrue
  \ble@dtrue
  \bgroup
    \def\t@stsz{1}%
    %\def\t@stsz{.33}%
    \PaperHeight=\the\dimexpr \t@stsz\dimexpr\csname cover-Y-#1\endcsname +\tble@d+\bble@d\relax\relax
    \PaperWidth=\the\dimexpr \t@stsz\dimexpr\csname cover-X-#1\endcsname +\rble@d+\lble@d\relax\relax
    \hsize=\PaperWidth
    \esb\cat cover_#1\cat*#2
    \ifx\b@drbottom\tr@e
      \getsbp@ram{borderbpadding}%
      \global\let\bpp@ram\p@ram
    \else
      \gdef\bpp@ram{0}%
    \fi
    \esbe%
    \trace{cov}{Request (#1)  was (\the\PaperHeight x\the\PaperWidth) bpparam=\bpp@ram}%
    \trace{cov}{Wholepagepic is (\the\ht\wholepagepic+\the\dp\wholepagepic)x\the\wd\wholepagepic\space w <\the\dimexpr-\b@dr@left@pad\relax, \fb@lpadding |\the\dimexpr -\b@dr@right@pad\relax,\fb@rpadding>\space hpadding and hbleed of \the\dimexpr \lble@d + \rble@d\relax. Vpadding: <\the\dimexpr-\b@dr@top@pad\relax|\the\dimexpr -\b@dr@bot@pad\relax>, \the\dimexpr \tble@d\relax,\the\dimexpr \bble@d\relax}%
    \hskip -\dimexpr \b@dr@left@pad\relax
    \ifhasb@rder
      \trace{cov}{Cover had border}%
      \raise\dimexpr \bble@d\ifx\bpp@ram\relax\else -\bpp@ram pt\fi\relax\hbox{\box\wholepagepic}%
    \else
      \trace{cov}{Cover had no border}%
      \box\wholepagepic%}%\lower-\bble@d\hbox{\box\wholepagepic}%
    \fi
    \hskip -\dimexpr \b@dr@right@pad\relax
  \egroup
} 

\def\cover@maths{%
  \global\rotatespinefalse
  \bgroup\s@tc@tprefix{cover_spine}\getsbp@ram{sbarrotation}%
  \ifx\cp@ram\relax\else
    \trace{cov}{Rotating spine? \cp@ram}%
    \ifcsname geom@xform@\cp@ram\endcsname
      \setgeomtransform{\cp@ram}%
      \message{Rotating spine? \cp@ram => \pdf@aa / \pdf@ab}%
      \ifnum \pdf@aa=0 
	\global\rotatespinetrue
      \fi
      \ifnum \pdf@ab=1
        \global\let\r@tSet\r@cwSet%
        \x@\global\x@\let\x@\@@spineafterskip\csname cover-back-spinewrap\endcsname
        \x@\global\x@\let\x@\@@spinebeforeskip\csname cover-front-spinewrap\endcsname
      \else
        \global\let\r@tSet\r@acwSet%
        \x@\global\x@\let\x@\@@spineafterskip\csname cover-front-spinewrap\endcsname
        \x@\global\x@\let\x@\@@spinebeforeskip\csname cover-back-spinewrap\endcsname
      \fi
    \fi
  \fi\egroup
  \ifrotatespine
    \x@\let\csname cover-X-spine\x@\endcsname\csname cover-y\endcsname
    \x@\edef\csname cover-Y-spine\endcsname{\the\dimexpr \csname cover-spine\endcsname + \csname cover-back-spinewrap\endcsname + \csname cover-front-spinewrap\endcsname\relax}%
  \else
    \x@\let\csname cover-Y-spine\x@\endcsname\csname cover-y\endcsname
    \x@\edef\csname cover-X-spine\endcsname{\the\dimexpr \csname cover-spine\endcsname + \csname cover-back-spinewrap\endcsname + \csname cover-front-spinewrap\endcsname\relax}%
  \fi
  \x@\let\csname cover-Y-front\x@\endcsname\csname cover-y\endcsname
  \x@\let\csname cover-Y-back\x@\endcsname\csname cover-y\endcsname
  \x@\edef\csname cover-X-front\endcsname{\the\dimexpr \csname cover-x\endcsname - \csname cover-front-spinewrap\endcsname\relax}%
  \x@\edef\csname cover-X-back\endcsname{\the\dimexpr \csname cover-x\endcsname - \csname cover-back-spinewrap\endcsname\relax}%
  \x@\edef\csname cover-X-whole\endcsname{\the\dimexpr \csname cover-spine\endcsname +\csname cover-x\endcsname *2\relax }
  \x@\edef\csname cover-Y-whole\endcsname{\the\dimexpr \csname cover-y\endcsname \relax}
  %  
}
\def\d@spine{{%
  \ifrotatespine
    \edef\lble@d{\csname cover-bleed\endcsname}%
    \edef\rble@d{\csname cover-bleed\endcsname}%
    \trace{cov}{Rotated spine}%
    \setbox0\hbox{\hskip\lble@d\c@verbit{spine}{\topskip=1pt 
      \vskip \@@spinebeforeskip
      \vfill\csname periphcontents=spine\endcsname\vfill
      \vskip \@@spineafterskip
    }\hskip\rble@d}%
    \trace{cov}{Rotating spine \pdf@ab. \the\ht0+\the\dp0 x\the\wd0}%
    \setbox0\hbox{\rot@tebz}%
    %\showbox0
    \message{Rotating spine \the\ht0+\the\dp0 x\the\wd0}%
    \raise\dimexpr\dp0\box0
  \else
    \trace{cov}{NOT Rotating spine??}%
    \edef\tble@d{\csname cover-bleed\endcsname}%
    \edef\bble@d{\csname cover-bleed\endcsname}%
    \c@verbit{spine}{\topskip=0pt \csname periphcontents=spine\endcsname}%
  \fi
}}

\def\leftble@d{%
  \edef\lble@d{\csname cover-bleed\endcsname}%
  \edef\tble@d{\csname cover-bleed\endcsname}%
  \edef\bble@d{\csname cover-bleed\endcsname}%
  \edef\rble@d{0pt}%
}
\def\rightble@d{%
  \edef\rble@d{\csname cover-bleed\endcsname}%
  \edef\tble@d{\csname cover-bleed\endcsname}%
  \edef\bble@d{\csname cover-bleed\endcsname}%
  \edef\lble@d{0pt}%
}

\def\m@kecover{%
  \temptrue
  \ifcsname periphcontents=frontcover\endcsname\else\tempfalse\fi
  \ifcsname periphcontents=backcover\endcsname\else\tempfalse\fi
  \iftemp
    %\tracingassigns=1
    \cover@maths
    %\tracingassigns=0
    \setbox0\hbox{%
      \c@verbit{whole}{\topskip=0pt 
    %    \tracingall
        \vskip -\csname cover-bleed\endcsname plus 1fil minus 1fil
        \BoxLikeBordertrue
        \ifBookOpenLeft
          \hbox{{\leftble@d\c@verbit{front}{\csname periphcontents=frontcover\endcsname}
            }%
            \d@spine
            {\rightble@d
              \c@verbit{back}{\csname periphcontents=backcover\endcsname}}%
          }%
        \else
          \hbox{{\leftble@d
              \c@verbit{back}{\csname periphcontents=backcover\endcsname}%
            }%
            \d@spine
            {\rightble@d
              \c@verbit{front}{\csname periphcontents=frontcover\endcsname}}%
          }%
        \fi
        \vskip -\csname cover-bleed\endcsname plus 1fil minus 1fil
      }%
    }%%
    \def\pagecontents{\copy0}\plainoutput
    \ifnum\interactionmode=2
      \showbox0
    \fi
    \trace{cov}{ship@utcoverinsert{cover}{}{\csname cover-y-spine\endcsname}{\csname cover-bleed\endcsname} \space box is (\the\ht0+\the\dp0)x\the\wd0}%
    \ship@utcoverinsert{cover}{0}{\csname cover-spine\endcsname}{\csname cover-bleed\endcsname}%
  \else
    \message{No cover produced, as periphery missing (\ifcsname periphcontents=frontcover\endcsname\else frontcover\fi\ \ifcsname periphcontents=backcover\endcsname backcover\fi)}%
  \fi
}
%\addtoendhooks{\m@kecover}
\plugin@endif
